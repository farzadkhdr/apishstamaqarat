#!/usr/bin/env node

const fs = require('fs').promises;
const path = require('path');

async function generateStats() {
    try {
        const dataDir = path.join(__dirname, '..', 'data');
        const files = await fs.readdir(dataDir);
        
        console.log('ğŸ“Š Ø¦Ø§Ù…Ø§Ø±ÛŒ Ø¯Ø§ØªØ§Ú©Ø§Ù†:\n');
        
        for (const file of files.filter(f => f.endsWith('.json'))) {
            try {
                const filePath = path.join(dataDir, file);
                const data = await fs.readFile(filePath, 'utf8');
                const jsonData = JSON.parse(data);
                
                console.log(`ğŸ“„ ${file}:`);
                console.log(`   ğŸ“Š Ú˜Ù…Ø§Ø±Û•ÛŒ ØªÛ†Ù…Ø§Ø±Û•Ú©Ø§Ù†: ${jsonData.length}`);
                
                if (file === 'requests.json' && jsonData.length > 0) {
                    const statusCounts = {};
                    const typeCounts = {};
                    
                    jsonData.forEach(item => {
                        statusCounts[item.status] = (statusCounts[item.status] || 0) + 1;
                        typeCounts[item.type] = (typeCounts[item.type] || 0) + 1;
                    });
                    
                    console.log('   ğŸ·ï¸  Ø¯Û†Ø®Û•Ú©Ø§Ù†:');
                    Object.entries(statusCounts).forEach(([status, count]) => {
                        console.log(`        ${status}: ${count}`);
                    });
                    
                    console.log('   ğŸ  Ø¬Û†Ø±Û•Ú©Ø§Ù†:');
                    Object.entries(typeCounts).forEach(([type, count]) => {
                        console.log(`        ${type}: ${count}`);
                    });
                }
                
                if (file === 'advertisements.json' && jsonData.length > 0) {
                    const totalViews = jsonData.reduce((sum, ad) => sum + (ad.views || 0), 0);
                    const totalClicks = jsonData.reduce((sum, ad) => sum + (ad.clicks || 0), 0);
                    const activeAds = jsonData.filter(ad => ad.status === 'active').length;
                    
                    console.log(`   ğŸ‘ï¸  Ú©Û†ÛŒ Ø¨ÛŒÙ†ÛŒÙ†Û•Ú©Ø§Ù†: ${totalViews}`);
                    console.log(`   ğŸ–±ï¸  Ú©Û†ÛŒ Ú©Ù„ÛŒÚ©Û•Ú©Ø§Ù†: ${totalClicks}`);
                    console.log(`   ğŸŸ¢ Ø±ÛÚ©Ù„Ø§Ù…Û• Ú†Ø§Ù„Ø§Ú©Û•Ú©Ø§Ù†: ${activeAds}`);
                }
                
                console.log('');
            } catch (error) {
                console.error(`âŒ Ù‡Û•ÚµÛ• Ù„Û• Ø®ÙˆÛÙ†Ø¯Ù†Û•ÙˆÛ•ÛŒ ${file}:`, error.message);
            }
        }
        
        // Ù‚Û•Ø¨Ø§Ø±Û•ÛŒ ÙØ§ÛŒÙ„Û•Ú©Ø§Ù†
        console.log('ğŸ“ Ù‚Û•Ø¨Ø§Ø±Û•ÛŒ ÙØ§ÛŒÙ„Û•Ú©Ø§Ù†:');
        for (const file of files.filter(f => f.endsWith('.json'))) {
            try {
                const filePath = path.join(dataDir, file);
                const stats = await fs.stat(filePath);
                const sizeKB = (stats.size / 1024).toFixed(2);
                console.log(`   ${file}: ${sizeKB} KB`);
            } catch (error) {
                console.error(`âŒ Ù‡Û•ÚµÛ• Ù„Û• ÙˆÛ•Ø±Ú¯Ø±ØªÙ†ÛŒ Ù‚Û•Ø¨Ø§Ø±Û•ÛŒ ${file}:`, error.message);
            }
        }
        
    } catch (error) {
        console.error('ğŸ”¥ Ù‡Û•ÚµÛ• Ù„Û• Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ Ø¦Ø§Ù…Ø§Ø±Û•Ú©Ø§Ù†:', error);
    }
}

if (require.main === module) {
    generateStats();
}

module.exports = generateStats;